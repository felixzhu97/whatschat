# TOGAF 规范

## 核心概念

TOGAF (The Open Group Architecture Framework) 是企业架构开发的标准框架，包含：

1. **ADM** (Architecture Development Method) - 架构开发方法
2. **四大架构域** - 业务、应用、数据、技术架构
3. **架构内容框架** - 架构产物的标准结构
4. **架构能力框架** - 企业架构治理能力

## 四大架构域

### Business Architecture（业务架构）

**定义**：描述组织的业务流程、组织结构、业务能力和业务价值流

**在本项目中**：

- 用户管理、即时通讯、语音视频通话、文件共享、群组管理、联系人管理、通知管理、状态分享
- 业务流程：用户注册登录、发送消息、发起通话、创建群组、状态分享、文件上传、联系人添加

**文档位置**：`docs/architecture/togaf/business-architecture.puml`

### Application Architecture（应用架构）

**定义**：描述应用系统的结构、应用组件、接口和交互关系

**在本项目中**：

- 客户端应用层：Web 应用（Next.js 15、React 19）、移动应用（React Native、Expo）
- API 网关层：REST API 网关、WebSocket 网关、WebRTC 信令
- 应用服务层：认证服务、用户服务、消息服务、聊天服务、通话服务、群组服务、状态服务、文件服务、通知服务
- 业务逻辑层：消息处理逻辑、实时通信逻辑、权限控制逻辑、业务规则引擎
- 数据访问层：数据仓库、缓存服务
- 基础设施服务：PostgreSQL、Redis、文件存储、搜索服务

**文档位置**：`docs/architecture/togaf/application-architecture.puml`

**代码位置**：

- `apps/web/` - Web 应用（含 app、domain、application、infrastructure、presentation）
- `apps/mobile/` - 移动应用（同上分层结构）
- `apps/server/` - 后端服务（含 domain、application、infrastructure、presentation）

### Data Architecture（数据架构）

**定义**：描述数据的结构、数据流、数据存储和数据管理

**在本项目中**：

- 数据实体层：User、Chat、Message、Group、Call、Status、Contact、Notification、FileUpload
- 关联实体：ChatParticipant、GroupParticipant、CallParticipant、MessageRead、MessageReaction、StatusView、UserSettings、BlockedUser
- 数据存储：PostgreSQL 主数据库、Redis 缓存和会话、MinIO/S3 文件存储
- 数据流：写数据流、读数据流、实时数据流（Redis Pub/Sub + WebSocket）

**文档位置**：`docs/architecture/togaf/data-architecture.puml`

**代码位置**：

- `apps/server/prisma/` - Schema 定义、迁移文件
- `apps/server/src/` - 数据访问与缓存逻辑（infrastructure、application 层）

### Technology Architecture（技术架构）

**定义**：描述技术平台、基础设施、技术标准和部署架构

**在本项目中**：

- 客户端技术栈：Web（Next.js 15、React 19、TypeScript、Tailwind CSS、Zustand、WebSocket、WebRTC）、移动（React Native、Expo、TypeScript、Zustand）
- 应用服务器：NestJS 10、Express、Node.js、REST API、Socket.IO、WebRTC 信令、JWT、Passport、bcrypt、Helmet、CORS
- 数据持久化：PostgreSQL 13+、Prisma ORM、Redis 6+
- 文件存储：MinIO/S3、Sharp（图像处理）
- 搜索服务：Elasticsearch（全文搜索，可选）
- 消息队列：Redis Pub/Sub、Bull Queue
- 部署：Docker、Docker Compose、Nginx、负载均衡

**文档位置**：`docs/architecture/togaf/technology-architecture.puml`

## ADM 核心流程

ADM 是 TOGAF 的架构开发方法，包含 9 个阶段（核心简化版）：

### 阶段 A：架构愿景 (Architecture Vision)

- 定义架构范围、目标、利益相关者
- 识别业务驱动因素和业务需求

### 阶段 B：业务架构 (Business Architecture)

- 建立业务架构基线
- 开发业务架构目标
- 识别业务架构差距

### 阶段 C：信息系统架构 (Information Systems Architecture)

- 数据架构（阶段 C1）：数据实体、数据关系、数据流
- 应用架构（阶段 C2）：应用组件、应用接口、应用交互

### 阶段 D：技术架构 (Technology Architecture)

- 定义技术平台
- 识别技术标准和规范
- 制定技术架构蓝图

### 阶段 E：机会和解决方案 (Opportunities and Solutions)

- 识别架构实施机会
- 制定实施路线图
- 评估风险和依赖

### 阶段 F：迁移规划 (Migration Planning)

- 制定详细的迁移计划
- 定义过渡架构
- 制定实施时间表

### 阶段 G：实施治理 (Implementation Governance)

- 监督架构实施
- 确保实施符合架构标准
- 管理架构变更请求

### 阶段 H：架构变更管理 (Architecture Change Management)

- 管理架构变更
- 维护架构连续性
- 评估架构演进需求

### 需求管理 (Requirements Management)

- 贯穿所有阶段的持续活动
- 管理架构需求的变更和追溯

## 架构原则

### 1. 业务原则

- **原则至上**：业务需求驱动架构决策
- **信息资产**：数据是企业资产，需要统一管理
- **技术无关性**：业务架构独立于技术实现

### 2. 应用原则

- **组件化**：应用以组件形式构建，便于重用和维护
- **接口标准化**：组件间通过标准化接口交互
- **服务导向**：采用服务导向的架构设计

### 3. 数据原则

- **数据共享**：数据在应用间共享，避免重复
- **数据安全**：数据访问受控，确保安全性
- **数据质量**：数据必须准确、完整、及时

### 4. 技术原则

- **技术标准化**：采用行业标准技术，减少技术债务
- **平台化**：构建可重用的技术平台
- **可扩展性**：技术架构支持业务增长和扩展

## 架构产物

### 架构基线 (Baseline Architecture)

- 描述当前架构状态
- 作为对比参考点

### 目标架构 (Target Architecture)

- 描述期望的架构状态
- 满足业务和技术目标

### 差距分析 (Gap Analysis)

- 识别基线和目标架构间的差距
- 定义填补差距的解决方案

### 过渡架构 (Transition Architecture)

- 定义从基线到目标的中间状态
- 支持分阶段实施

## 项目映射

### 架构文档

```text
docs/architecture/togaf/
├── overview.puml              # 总体架构概览
├── business-architecture.puml # 业务架构图
├── application-architecture.puml # 应用架构图
├── data-architecture.puml     # 数据架构图
└── technology-architecture.puml # 技术架构图
```

### 代码结构映射

**业务架构** → 业务需求和能力定义

**应用架构** →

- `apps/web/` - Web 应用（app、domain、application、infrastructure、presentation）
- `apps/mobile/` - 移动应用（同上分层结构）
- `apps/server/` - 后端服务（domain、application、infrastructure、presentation）

**数据架构** →

- `apps/server/prisma/` - Schema、migrations
- `apps/server/src/` - 数据访问与缓存逻辑

**技术架构** →

- 各 app 的 `package.json`、`tsconfig.json`
- 根目录 `turbo.json`、`pnpm-workspace.yaml`

## 架构治理规则

### 架构评审

- 新功能开发前进行架构影响分析
- 重大变更需要架构评审
- 确保架构文档与代码同步更新

### 依赖管理

```text
业务架构 → 应用架构 → 数据架构 → 技术架构
```

- 上层架构依赖下层架构
- 下层架构变更需评估上层影响
- 禁止反向依赖

### 文档维护

- 架构变更时同步更新架构图
- 保持架构文档与代码实现一致
- 定期审查架构对齐情况

## 检查清单

### 新功能开发

- [ ] 明确功能所属的架构域
- [ ] 评估对现有架构的影响
- [ ] 确保符合架构原则
- [ ] 更新相关架构文档

### 架构变更

- [ ] 识别受影响的架构域
- [ ] 进行差距分析
- [ ] 定义过渡方案
- [ ] 更新架构图和文档
- [ ] 通知相关利益相关者

### 架构对齐

- [ ] 代码实现符合架构设计
- [ ] 架构文档反映实际状态
- [ ] 遵循架构依赖规则
- [ ] 符合架构原则要求

## 参考资源

- [TOGAF 官方文档](https://www.opengroup.org/togaf)
- [项目 TOGAF 架构图](../../docs/architecture/togaf/README.md)
- [架构概览图](../../docs/architecture/togaf/overview.puml)
