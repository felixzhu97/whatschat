@startuml
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho

title WhatsChat 数据复制与分片图

package "应用层" {
  component [API服务] as API
  component [只读服务] as ReadOnlyService
}

package "PostgreSQL主从复制" {
  database [PostgreSQL主库\n(写操作)] as MasterDB {
    component [WAL日志] as WAL
    component [主库数据] as MasterData
  }
  
  database [PostgreSQL从库1\n(读操作)] as Slave1 {
    component [复制进程] as Replication1
    component [从库数据] as SlaveData1
  }
  
  database [PostgreSQL从库2\n(读操作)] as Slave2 {
    component [复制进程] as Replication2
    component [从库数据] as SlaveData2
  }
}

package "备份策略" {
  component [定期备份] as Backup
  database [备份存储] as BackupStorage
}

package "故障切换" {
  component [监控服务] as Monitor
  component [故障检测] as Failover
  component [主从切换] as Promote
}

' 写操作流程
API --> MasterDB : 1. 写操作 (INSERT/UPDATE/DELETE)
MasterDB --> MasterData : 2. 写入数据
MasterDB --> WAL : 3. 写入WAL日志

' 主从复制流程
WAL --> Replication1 : 4. 流复制 (Streaming Replication)
WAL --> Replication2 : 4. 流复制
Replication1 --> SlaveData1 : 5. 应用WAL日志
Replication2 --> SlaveData2 : 5. 应用WAL日志
Slave1 --> API : 6. 复制延迟监控
Slave2 --> API : 6. 复制延迟监控

' 读操作负载均衡
ReadOnlyService --> Slave1 : 7. 读请求 (SELECT)
ReadOnlyService --> Slave2 : 7. 读请求 (负载均衡)
API --> Slave1 : 8. 读操作 (从库1)
API --> Slave2 : 8. 读操作 (从库2)

' 备份流程
Backup --> MasterDB : 9. 定期备份 (pg_basebackup)
MasterDB --> BackupStorage : 10. 备份文件
BackupStorage --> Backup : 11. 备份验证

' 故障监控
Monitor --> MasterDB : 12. 健康检查
Monitor --> Slave1 : 13. 健康检查
Monitor --> Slave2 : 14. 健康检查
Monitor --> Failover : 15. 故障检测

' 故障切换流程
alt 主库故障
  Failover --> Monitor : 16. 检测到主库故障
  Monitor --> Promote : 17. 触发主从切换
  Promote --> Slave1 : 18. 提升从库1为主库
  Promote --> API : 19. 更新连接配置
  API --> Slave1 : 20. 切换到新主库
else 从库故障
  Failover --> Monitor : 16. 检测到从库故障
  Monitor --> ReadOnlyService : 17. 从负载均衡中移除
  ReadOnlyService --> Slave1 : 18. 所有读请求路由到从库1
end

partition "数据同步细节" {
  note as N1
    **流复制机制**
    - WAL日志实时传输
    - 异步复制 (性能优先)
    - 同步复制 (一致性优先，可选)
    - 复制延迟监控
    - 自动重连机制
  end note
}

partition "读写分离策略" {
  note as N2
    **读写分离规则**
    
    **写操作 (主库)**:
    - INSERT
    - UPDATE
    - DELETE
    - CREATE TABLE
    - ALTER TABLE
    - 事务操作
    
    **读操作 (从库)**:
    - SELECT查询
    - 统计查询
    - 报表生成
    - 数据分析
  end note
}

note right of MasterDB
  **主库特性**
  - 处理所有写操作
  - 生成WAL日志
  - 实时复制到从库
  - 支持同步/异步复制
  - 事务日志持久化
end note

note right of Slave1
  **从库特性**
  - 只读访问
  - 实时同步主库数据
  - 负载均衡读请求
  - 故障时提升为主库
  - 复制延迟 < 100ms
end note

note right of Backup
  **备份策略**
  - 每日全量备份
  - 每小时增量备份
  - 保留30天备份
  - 异地备份存储
  - 定期备份验证
end note

note bottom
  **数据复制架构说明**
  
  1. **主从复制**: PostgreSQL流复制，WAL日志实时传输
  2. **读写分离**: 写操作在主库，读操作在从库负载均衡
  3. **高可用**: 主库故障时自动切换从库为主库
  4. **数据一致性**: 异步复制保证最终一致性
  5. **备份恢复**: 定期全量和增量备份，支持快速恢复
  6. **监控告警**: 实时监控复制延迟和节点健康状态
end note

@enduml

