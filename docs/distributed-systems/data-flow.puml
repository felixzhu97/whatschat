@startuml
!theme plain
skinparam activity {
  BackgroundColor lightblue
  BorderColor black
  FontSize 12
}

title WhatsChat 数据流图

start

:客户端请求;

partition "客户端层" {
  :Web/移动客户端;
}

partition "接入层" {
  :API网关;
  :负载均衡;
}

partition "应用服务层" {
  :API服务 (NestJS);
  note right
    - 请求验证
    - 认证鉴权
    - 业务逻辑处理
  end note
}

partition "数据层" {
  :PostgreSQL;
  :Redis缓存;
  :对象存储;
}

' 用户认证数据流
partition "场景1: 用户登录" {
  :客户端发送登录请求;
  :请求到达API网关;
  :负载均衡转发;
  :API服务接收请求;
  if (Redis中是否有会话?) then (是)
    :从Redis读取会话;
    :返回登录状态;
  else (否)
    :验证用户名密码;
    :查询PostgreSQL用户信息;
    if (验证成功?) then (是)
      :生成JWT令牌;
      :存储会话到Redis;
      :返回令牌给客户端;
    else (否)
      :返回错误;
    endif
  endif
}

' 消息发送数据流
partition "场景2: 发送消息" {
  :客户端发送消息;
  :请求到达API网关;
  :负载均衡转发;
  :API服务接收请求;
  :验证用户权限;
  :创建消息记录;
  :写入PostgreSQL主库;
  :缓存消息到Redis;
  :发布消息事件到Redis Pub/Sub;
  :WebSocket推送消息;
  :返回发送成功;
}

' 文件上传数据流
partition "场景3: 文件上传" {
  :客户端上传文件;
  :请求到达API网关;
  :负载均衡转发;
  :API服务接收请求;
  :验证文件类型和大小;
  :上传到对象存储;
  :获取文件URL;
  :保存文件元数据到PostgreSQL主库;
  :返回文件URL;
}

' 消息查询数据流
partition "场景4: 查询消息" {
  :客户端请求历史消息;
  :请求到达API网关;
  :负载均衡转发;
  :API服务接收请求;
  if (Redis中有缓存?) then (是)
    :从Redis读取缓存;
  else (否)
    :从PostgreSQL从库查询消息记录;
    :缓存到Redis;
  endif
  :返回消息列表;
}

' 实时消息推送数据流
partition "场景5: 实时消息推送" {
  :API服务收到新消息;
  :发布消息事件到Redis Pub/Sub;
  note right
    **事件主题**
    - message:new
    - message:updated
    - user:online
    - user:offline
  end note
  :WebSocket服务订阅事件;
  :推送给在线用户;
  :客户端接收消息;
}

stop

note right
  **数据流说明**
  
  1. **认证流程**: 客户端 -> API网关 -> API服务 -> PostgreSQL/Redis
  2. **消息发送**: 客户端 -> API服务 -> PostgreSQL -> Redis Pub/Sub -> WebSocket -> 客户端
  3. **文件上传**: 客户端 -> API服务 -> 对象存储 -> PostgreSQL
  4. **消息查询**: 客户端 -> API服务 -> Redis缓存 / PostgreSQL从库
  5. **实时推送**: API服务 -> Redis Pub/Sub -> WebSocket服务 -> 客户端
end note

@enduml

