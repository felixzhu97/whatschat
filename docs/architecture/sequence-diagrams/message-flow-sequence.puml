# 消息发送接收时序图

```mermaid
sequenceDiagram
    participant S as 发送者
    participant WS as WebSocket客户端
    participant WS_S as WebSocket服务器
    participant A as API服务器
    participant D as 数据库
    participant R as 接收者

    Note over S,R: 消息发送流程

    S->>WS: 输入消息内容
    WS->>WS_S: 发送消息事件
    Note right of WS: {type: 'send_message', content, chatId}
    
    WS_S->>WS_S: 验证用户身份
    WS_S->>A: 保存消息到数据库
    A->>D: INSERT INTO messages
    D-->>A: 返回消息ID
    A-->>WS_S: 消息保存成功
    
    WS_S->>WS_S: 广播消息给接收者
    WS_S->>R: 推送新消息通知
    Note right of WS_S: {type: 'new_message', message}
    
    R->>R: 更新聊天界面
    R-->>WS_S: 消息接收确认

    Note over S,R: 消息状态更新

    WS_S->>A: 更新消息状态
    A->>D: UPDATE message_status
    D-->>A: 更新成功
    A-->>WS_S: 状态更新完成
    
    WS_S->>S: 推送状态更新
    Note right of WS_S: {type: 'message_status', status}

    Note over S,R: 消息编辑流程

    S->>WS: 编辑消息
    WS->>WS_S: 发送编辑事件
    Note right of WS: {type: 'edit_message', messageId, newContent}
    
    WS_S->>A: 更新消息内容
    A->>D: UPDATE messages SET content
    D-->>A: 更新成功
    A-->>WS_S: 编辑完成
    
    WS_S->>R: 推送消息更新
    Note right of WS_S: {type: 'message_updated', message}

    Note over S,R: 消息删除流程

    S->>WS: 删除消息
    WS->>WS_S: 发送删除事件
    Note right of WS: {type: 'delete_message', messageId}
    
    WS_S->>A: 软删除消息
    A->>D: UPDATE messages SET deleted_at
    D-->>A: 删除成功
    A-->>WS_S: 删除完成
    
    WS_S->>R: 推送删除通知
    Note right of WS_S: {type: 'message_deleted', messageId}

    Note over S,R: 文件消息发送

    S->>WS: 选择文件
    WS->>WS_S: 发送文件上传请求
    Note right of WS: {type: 'upload_file', file}
    
    WS_S->>A: 处理文件上传
    A->>A: 验证文件类型和大小
    A->>A: 上传到文件存储
    A->>D: 保存文件信息
    D-->>A: 返回文件ID
    A-->>WS_S: 文件上传成功
    
    WS_S->>WS_S: 创建文件消息
    WS_S->>A: 保存消息记录
    A->>D: INSERT INTO messages
    D-->>A: 返回消息ID
    
    WS_S->>R: 推送文件消息
    Note right of WS_S: {type: 'new_message', message}
```
