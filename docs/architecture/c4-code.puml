@startuml
!include lib/C4_Component.puml

title WhatsChat 核心模块代码图

Container_Boundary(webApp, "Web应用代码结构 (Next.js 15)") {
    
    Boundary(pages, "页面层 (app/)") {
        Component(rootLayout, "layout.tsx", "Next.js Layout", "应用根布局，包含全局样式和元数据")
        Component(rootPage, "page.tsx", "Next.js Page", "应用根页面，主要入口点")
        Component(loginPage, "login/page.tsx", "Next.js Page", "用户登录页面")
        Component(registerPage, "register/page.tsx", "Next.js Page", "用户注册页面")
        Component(globalCSS, "globals.css", "CSS Styles", "全局样式定义")
    }
    
    Boundary(components, "组件层 (components/)") {
        Component(authWrapper, "auth-wrapper.tsx", "React Component", "认证路由守卫和状态管理")
        Component(whatsappMain, "whatsapp-main.tsx", "React Component", "WhatsApp风格主界面")
        Component(chatArea, "chat-area.tsx", "React Component", "聊天区域容器")
        Component(chatHeader, "chat-header.tsx", "React Component", "聊天头部信息")
        Component(sidebar, "sidebar.tsx", "React Component", "侧边栏导航")
        Component(messageArea, "message-area.tsx", "React Component", "消息显示区域")
        Component(messageBubble, "message-bubble.tsx", "React Component", "消息气泡组件")
        Component(messageInput, "message-input.tsx", "React Component", "消息输入组件")
        Component(callInterface, "call-interface.tsx", "React Component", "通话界面")
        Component(realCallInterface, "real-call-interface.tsx", "React Component", "真实通话界面")
        Component(incomingCall, "incoming-call.tsx", "React Component", "来电界面")
        Component(realIncomingCall, "real-incoming-call.tsx", "React Component", "真实来电界面")
        Component(emojiPicker, "emoji-picker.tsx", "React Component", "表情选择器")
        Component(voiceRecorder, "voice-recorder.tsx", "React Component", "语音录制组件")
        Component(fileUpload, "file-upload.tsx", "React Component", "文件上传组件")
        Component(profilePage, "profile-page.tsx", "React Component", "个人资料页面")
        Component(settingsPage, "settings-page.tsx", "React Component", "设置页面")
        Component(callsPage, "calls-page.tsx", "React Component", "通话记录页面")
        Component(statusPage, "status-page.tsx", "React Component", "状态页面")
    }
    
    Boundary(hooks, "Hooks层 (hooks/)") {
        Component(useAuth, "use-auth.ts", "React Hook", "用户认证状态管理")
        Component(useChat, "use-chat.ts", "React Hook", "聊天状态管理")
        Component(useRealChat, "use-real-chat.ts", "React Hook", "真实聊天功能实现")
        Component(useCall, "use-call.ts", "React Hook", "通话状态管理")
        Component(useRealCall, "use-real-call.ts", "React Hook", "真实通话功能实现")
        Component(useLongPress, "use-long-press.ts", "React Hook", "长按手势处理")
        Component(useVoiceRecorder, "use-voice-recorder.ts", "React Hook", "语音录制功能")
        Component(useMobile, "use-mobile.tsx", "React Hook", "移动端检测")
        Component(useToast, "use-toast.ts", "React Hook", "消息提示管理")
    }
    
    Boundary(stores, "状态管理 (stores/)") {
        Component(messagesStore, "messages-store.ts", "Zustand Store", "消息状态管理")
        Component(contactsStore, "contacts-store.ts", "Zustand Store", "联系人状态管理")
        Component(callsStore, "calls-store.ts", "Zustand Store", "通话状态管理")
        Component(settingsStore, "settings-store.ts", "Zustand Store", "设置状态管理")
    }
    
    Boundary(lib, "工具库 (lib/)") {
        Component(utils, "utils.ts", "TypeScript Utilities", "通用工具函数")
        Component(websocket, "websocket.ts", "TypeScript Service", "WebSocket连接管理")
        Component(webrtc, "webrtc.ts", "TypeScript Service", "WebRTC连接管理")
        Component(api, "api.ts", "TypeScript Service", "HTTP API调用封装")
        Component(hapticFeedback, "haptic-feedback.ts", "TypeScript Service", "触觉反馈控制")
        Component(searchUtils, "search-utils.ts", "TypeScript Utilities", "搜索工具函数")
        Component(storage, "storage.ts", "TypeScript Service", "本地存储管理")
    }
    
    Boundary(types, "类型定义 (types/)") {
        Component(indexTypes, "index.ts", "TypeScript Interface", "主要类型定义和接口")
    }
    
    Boundary(data, "数据层 (data/)") {
        Component(mockData, "index.ts", "TypeScript Data", "模拟数据入口")
        Component(mockMessages, "mock-messages.ts", "TypeScript Data", "模拟消息数据")
        Component(mockContacts, "mock-contacts.ts", "TypeScript Data", "模拟联系人数据")
        Component(mockCalls, "mock-calls.ts", "TypeScript Data", "模拟通话数据")
        Component(mockStatus, "mock-status.ts", "TypeScript Data", "模拟状态数据")
    }
    
    Boundary(ui, "UI组件 (components/ui/)") {
        Component(button, "button.tsx", "Radix UI Component", "按钮组件")
        Component(dialog, "dialog.tsx", "Radix UI Component", "对话框组件")
        Component(input, "input.tsx", "Radix UI Component", "输入框组件")
        Component(avatar, "avatar.tsx", "Radix UI Component", "头像组件")
        Component(toast, "toast.tsx", "Radix UI Component", "消息提示组件")
    }
}

Container_Boundary(mobileApp, "移动应用代码结构 (Flutter 3.x)") {
    
    Boundary(screens, "屏幕层 (lib/screens/)") {
        Component(homeScreen, "home_screen.dart", "Flutter Widget", "主屏幕，底部导航")
        Component(chatListScreen, "chat_list_screen.dart", "Flutter Widget", "聊天列表屏幕")
        Component(chatDetailScreen, "chat_detail_screen.dart", "Flutter Widget", "聊天详情屏幕")
        Component(callsScreen, "calls_screen.dart", "Flutter Widget", "通话记录屏幕")
        Component(statusScreen, "status_screen.dart", "Flutter Widget", "状态屏幕")
        Component(settingsScreen, "settings_screen.dart", "Flutter Widget", "设置屏幕")
        Component(communitiesScreen, "communities_screen.dart", "Flutter Widget", "社区屏幕")
    }
    
    Boundary(widgets, "组件层 (lib/widgets/)") {
        Component(messageBubbleWidget, "message_bubble.dart", "Flutter Widget", "消息气泡组件")
        Component(chatInputField, "chat_input_field.dart", "Flutter Widget", "聊天输入框组件")
    }
    
    Boundary(models, "模型层 (lib/models/)") {
        Component(userModel, "user.dart", "Dart Class", "用户数据模型")
        Component(chatModel, "chat.dart", "Dart Class", "聊天数据模型")
        Component(messageModel, "message.dart", "Dart Class", "消息数据模型")
        Component(callModel, "call.dart", "Dart Class", "通话数据模型")
        Component(statusModel, "status.dart", "Dart Class", "状态数据模型")
        Component(modelsIndex, "models.dart", "Dart Export", "模型统一导出")
    }
    
    Boundary(services, "服务层 (lib/services/)") {
        Component(mobileServices, "服务目录", "Dart Services", "移动端服务实现（待实现）")
    }
    
    Boundary(themes, "主题层 (lib/themes/)") {
        Component(appTheme, "app_theme.dart", "Flutter Theme", "应用主题定义")
    }
    
    Boundary(main, "应用入口") {
        Component(mainDart, "main.dart", "Flutter App", "应用主入口文件")
    }
}

Container_Boundary(serverApp, "服务器代码结构 (NestJS - 整洁架构)") {
    
    Boundary(presentation, "表现层 (presentation/)") {
        Boundary(controllers, "控制器 (Controllers)") {
            Component(authController, "auth.controller.ts", "NestJS Controller", "认证控制器，处理注册、登录、令牌刷新")
            Component(usersController, "users.controller.ts", "NestJS Controller", "用户管理控制器")
            Component(messagesController, "messages.controller.ts", "NestJS Controller", "消息管理控制器")
            Component(chatsController, "chats.controller.ts", "NestJS Controller", "聊天管理控制器")
            Component(groupsController, "groups.controller.ts", "NestJS Controller", "群组管理控制器")
            Component(callsController, "calls.controller.ts", "NestJS Controller", "通话管理控制器")
            Component(statusController, "status.controller.ts", "NestJS Controller", "状态管理控制器")
            Component(healthController, "health.controller.ts", "NestJS Controller", "健康检查控制器")
        }
        
        Boundary(gateways, "网关 (Gateways)") {
            Component(chatGateway, "chat.gateway.ts", "NestJS Gateway", "WebSocket网关，处理实时消息、通话信令、状态更新")
        }
        
        Boundary(guards, "守卫 (Guards)") {
            Component(jwtAuthGuard, "jwt-auth.guard.ts", "NestJS Guard", "JWT认证守卫")
            Component(jwtStrategy, "jwt.strategy.ts", "Passport Strategy", "JWT策略")
        }
        
        Boundary(filters, "过滤器 (Filters)") {
            Component(allExceptionsFilter, "all-exceptions.filter.ts", "NestJS Filter", "全局异常过滤器")
            Component(httpExceptionFilter, "http-exception.filter.ts", "NestJS Filter", "HTTP异常过滤器")
            Component(validationExceptionFilter, "validation-exception.filter.ts", "NestJS Filter", "验证异常过滤器")
        }
        
        Boundary(interceptors, "拦截器 (Interceptors)") {
            Component(loggingInterceptor, "logging.interceptor.ts", "NestJS Interceptor", "日志拦截器")
            Component(transformInterceptor, "transform.interceptor.ts", "NestJS Interceptor", "响应转换拦截器")
        }
        
        Boundary(modules, "模块 (Modules)") {
            Component(appModule, "app.module.ts", "NestJS Module", "应用根模块，注册所有功能模块")
            Component(authModule, "auth.module.ts", "NestJS Module", "认证模块")
            Component(usersModule, "users.module.ts", "NestJS Module", "用户模块")
            Component(messagesModule, "messages.module.ts", "NestJS Module", "消息模块")
            Component(chatsModule, "chats.module.ts", "NestJS Module", "聊天模块")
            Component(groupsModule, "groups.module.ts", "NestJS Module", "群组模块")
            Component(callsModule, "calls.module.ts", "NestJS Module", "通话模块")
            Component(statusModule, "status.module.ts", "NestJS Module", "状态模块")
            Component(websocketModule, "websocket.module.ts", "NestJS Module", "WebSocket模块")
            Component(healthModule, "health.module.ts", "NestJS Module", "健康检查模块")
        }
        
        Boundary(decorators, "装饰器 (Decorators)") {
            Component(currentUserDecorator, "current-user.decorator.ts", "NestJS Decorator", "当前用户装饰器")
            Component(publicDecorator, "public.decorator.ts", "NestJS Decorator", "公开路由装饰器")
        }
    }
    
    Boundary(application, "应用层 (application/)") {
        Boundary(services, "应用服务 (Services)") {
            Component(authService, "auth.service.ts", "Application Service", "认证服务，处理注册、登录、令牌生成")
            Component(usersService, "users.service.ts", "Application Service", "用户服务，处理用户业务逻辑")
            Component(messagesService, "messages.service.ts", "Application Service", "消息服务，处理消息业务逻辑")
            Component(chatsService, "chats.service.ts", "Application Service", "聊天服务，处理聊天业务逻辑")
            Component(groupsService, "groups.service.ts", "Application Service", "群组服务，处理群组业务逻辑")
            Component(callsService, "calls.service.ts", "Application Service", "通话服务，处理通话业务逻辑")
            Component(statusService, "status.service.ts", "Application Service", "状态服务，处理状态业务逻辑")
        }
        
        Boundary(dto, "数据传输对象 (DTOs)") {
            Component(authDto, "auth.dto.ts", "NestJS DTO", "认证相关DTO")
            Component(userDto, "user.dto.ts", "NestJS DTO", "用户相关DTO")
            Component(messageDto, "message.dto.ts", "NestJS DTO", "消息相关DTO")
        }
    }
    
    Boundary(domain, "领域层 (domain/)") {
        Boundary(entities, "实体 (Entities)") {
            Component(userEntity, "user.entity.ts", "Domain Entity", "用户领域实体")
            Component(messageEntity, "message.entity.ts", "Domain Entity", "消息领域实体")
            Component(chatEntity, "chat.entity.ts", "Domain Entity", "聊天领域实体")
            Component(groupEntity, "group.entity.ts", "Domain Entity", "群组领域实体")
        }
        
        Boundary(interfaces, "接口 (Interfaces)") {
            Boundary(repositoryInterfaces, "仓储接口 (Repositories)") {
                Component(userRepositoryInterface, "user.repository.interface.ts", "Domain Interface", "用户仓储接口")
                Component(messageRepositoryInterface, "message.repository.interface.ts", "Domain Interface", "消息仓储接口")
                Component(chatRepositoryInterface, "chat.repository.interface.ts", "Domain Interface", "聊天仓储接口")
            }
            
            Boundary(serviceInterfaces, "服务接口 (Services)") {
                Component(authServiceInterface, "auth.service.interface.ts", "Domain Interface", "认证服务接口")
                Component(socketServiceInterface, "socket.service.interface.ts", "Domain Interface", "Socket服务接口")
            }
        }
    }
    
    Boundary(infrastructure, "基础设施层 (infrastructure/)") {
        Boundary(database, "数据库 (Database)") {
            Component(prismaService, "prisma.service.ts", "NestJS Service", "Prisma数据库服务，PostgreSQL ORM")
            Component(redisService, "redis.service.ts", "NestJS Service", "Redis缓存服务")
            Component(databaseModule, "database.module.ts", "NestJS Module", "数据库模块")
        }
        
        Boundary(config, "配置 (Config)") {
            Component(configService, "config.service.ts", "NestJS Service", "配置服务，环境变量和配置管理")
        }
        
        Boundary(adapters, "适配器 (Adapters)") {
            Boundary(repositoryAdapters, "仓储适配器 (Repositories)") {
                Component(userRepositoryAdapter, "user.repository.adapter.ts", "Repository Adapter", "用户仓储适配器，实现领域接口")
            }
        }
    }
    
    Boundary(shared, "共享层 (shared/)") {
        Component(logger, "utils/logger.ts", "Utility", "日志工具")
        Component(validation, "utils/validation.ts", "Utility", "验证工具")
    }
    
    Boundary(main, "应用入口") {
        Component(mainTs, "main.ts", "NestJS Bootstrap", "应用启动入口，配置中间件、拦截器、过滤器")
    }
    
    Boundary(prisma, "数据库模式 (prisma/)") {
        Component(prismaSchema, "schema.prisma", "Prisma Schema", "数据库模式定义")
    }
}

' Web应用内部关系
Rel(rootLayout, rootPage, "包含根页面")
Rel(rootLayout, globalCSS, "引入全局样式")
Rel(authWrapper, loginPage, "未认证时显示")
Rel(authWrapper, registerPage, "注册跳转")
Rel(authWrapper, whatsappMain, "认证后显示")
Rel(whatsappMain, sidebar, "包含侧边栏")
Rel(whatsappMain, chatArea, "包含聊天区域")
Rel(chatArea, chatHeader, "包含聊天头部")
Rel(chatArea, messageArea, "包含消息区域")
Rel(messageArea, messageBubble, "渲染消息气泡")
Rel(chatArea, messageInput, "包含输入组件")
Rel(messageInput, emojiPicker, "表情选择")
Rel(messageInput, voiceRecorder, "语音录制")
Rel(messageInput, fileUpload, "文件上传")

' Hooks关系
Rel(authWrapper, useAuth, "认证状态管理")
Rel(chatArea, useChat, "聊天状态管理")
Rel(chatArea, useRealChat, "真实聊天功能")
Rel(callInterface, useCall, "通话状态管理")
Rel(realCallInterface, useRealCall, "真实通话功能")
Rel(voiceRecorder, useVoiceRecorder, "语音录制管理")
Rel(whatsappMain, useMobile, "移动端检测")
Rel(components, useToast, "消息提示")

' 状态管理关系
Rel(useChat, messagesStore, "消息状态")
Rel(sidebar, contactsStore, "联系人状态")
Rel(useCall, callsStore, "通话状态")
Rel(settingsPage, settingsStore, "设置状态")

' 服务关系
Rel(useRealChat, websocket, "WebSocket通信")
Rel(useRealCall, webrtc, "WebRTC通信")
Rel(useAuth, api, "API调用")
Rel(useAuth, storage, "存储管理")
Rel(messageArea, searchUtils, "搜索功能")
Rel(whatsappMain, hapticFeedback, "触觉反馈")

' UI组件关系
Rel(components, button, "使用按钮组件")
Rel(components, dialog, "使用对话框组件")
Rel(components, input, "使用输入框组件")
Rel(components, avatar, "使用头像组件")
Rel(useToast, toast, "使用消息提示组件")

' 数据关系
Rel(messagesStore, mockMessages, "使用模拟消息数据")
Rel(contactsStore, mockContacts, "使用模拟联系人数据")
Rel(callsStore, mockCalls, "使用模拟通话数据")
Rel(mockData, mockMessages, "导出消息数据")
Rel(mockData, mockContacts, "导出联系人数据")
Rel(mockData, mockCalls, "导出通话数据")

' 类型关系
Rel(hooks, indexTypes, "使用类型定义")
Rel(stores, indexTypes, "使用类型定义")
Rel(lib, indexTypes, "使用类型定义")

' 移动应用内部关系
Rel(mainDart, homeScreen, "启动主屏幕")
Rel(homeScreen, chatListScreen, "导航到聊天列表")
Rel(homeScreen, callsScreen, "导航到通话记录")
Rel(homeScreen, statusScreen, "导航到状态页面")
Rel(homeScreen, settingsScreen, "导航到设置页面")
Rel(chatListScreen, chatDetailScreen, "打开聊天详情")
Rel(chatDetailScreen, messageBubbleWidget, "显示消息气泡")
Rel(chatDetailScreen, chatInputField, "消息输入")

' 移动应用模型关系
Rel(chatDetailScreen, messageModel, "使用消息模型")
Rel(chatListScreen, chatModel, "使用聊天模型")
Rel(homeScreen, userModel, "使用用户模型")
Rel(modelsIndex, userModel, "导出用户模型")
Rel(modelsIndex, chatModel, "导出聊天模型")
Rel(modelsIndex, messageModel, "导出消息模型")
Rel(screens, appTheme, "使用应用主题")

' 服务器应用关系 - 整洁架构分层依赖
' 表现层 -> 应用层
Rel(authController, authService, "调用认证服务")
Rel(usersController, usersService, "调用用户服务")
Rel(messagesController, messagesService, "调用消息服务")
Rel(chatsController, chatsService, "调用聊天服务")
Rel(groupsController, groupsService, "调用群组服务")
Rel(callsController, callsService, "调用通话服务")
Rel(statusController, statusService, "调用状态服务")
Rel(chatGateway, messagesService, "调用消息服务")
Rel(chatGateway, statusService, "调用状态服务")

' 应用层 -> 领域层
Rel(authService, authServiceInterface, "实现认证服务接口")
Rel(authService, userRepositoryInterface, "使用用户仓储接口")
Rel(messagesService, messageRepositoryInterface, "使用消息仓储接口")
Rel(chatsService, chatRepositoryInterface, "使用聊天仓储接口")
Rel(usersService, userRepositoryInterface, "使用用户仓储接口")

' 应用层 -> 基础设施层
Rel(authService, prismaService, "使用Prisma服务")
Rel(messagesService, prismaService, "使用Prisma服务")
Rel(chatsService, prismaService, "使用Prisma服务")
Rel(chatGateway, prismaService, "使用Prisma服务")
Rel(chatGateway, redisService, "使用Redis服务")

' 基础设施层 -> 领域层
Rel(userRepositoryAdapter, userRepositoryInterface, "实现用户仓储接口")
Rel(userRepositoryAdapter, prismaService, "使用Prisma服务")

' 表现层内部关系
Rel(appModule, authModule, "导入认证模块")
Rel(appModule, usersModule, "导入用户模块")
Rel(appModule, messagesModule, "导入消息模块")
Rel(appModule, chatsModule, "导入聊天模块")
Rel(appModule, groupsModule, "导入群组模块")
Rel(appModule, callsModule, "导入通话模块")
Rel(appModule, statusModule, "导入状态模块")
Rel(appModule, websocketModule, "导入WebSocket模块")
Rel(appModule, healthModule, "导入健康检查模块")
Rel(authModule, authController, "注册认证控制器")
Rel(authModule, authService, "注册认证服务")
Rel(messagesModule, messagesController, "注册消息控制器")
Rel(messagesModule, messagesService, "注册消息服务")
Rel(websocketModule, chatGateway, "注册WebSocket网关")
Rel(authController, jwtAuthGuard, "使用JWT守卫")
Rel(jwtAuthGuard, jwtStrategy, "使用JWT策略")
Rel(appModule, allExceptionsFilter, "注册全局异常过滤器")
Rel(appModule, loggingInterceptor, "注册日志拦截器")
Rel(appModule, transformInterceptor, "注册响应转换拦截器")

' 应用层内部关系
Rel(authService, authDto, "使用认证DTO")
Rel(messagesService, messageDto, "使用消息DTO")
Rel(usersService, userDto, "使用用户DTO")

' 领域层内部关系
Rel(authService, userEntity, "使用用户实体")
Rel(messagesService, messageEntity, "使用消息实体")
Rel(chatsService, chatEntity, "使用聊天实体")
Rel(groupsService, groupEntity, "使用群组实体")

' 基础设施层内部关系
Rel(prismaService, prismaSchema, "使用数据库模式")
Rel(configService, prismaService, "提供配置")
Rel(configService, redisService, "提供配置")
Rel(databaseModule, prismaService, "注册Prisma服务")
Rel(databaseModule, redisService, "注册Redis服务")

' 应用启动关系
Rel(mainTs, appModule, "启动应用模块")
Rel(mainTs, allExceptionsFilter, "注册全局过滤器")
Rel(mainTs, loggingInterceptor, "注册全局拦截器")
Rel(mainTs, transformInterceptor, "注册全局拦截器")
Rel(mainTs, configService, "加载配置")

@enduml 