@startuml
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho

title TOGAF Data Architecture - WhatsChat Messaging System

package "Data Entities" {
  component [User] as User
  component [Chat] as Chat
  component [Message] as Message
  component [Group] as Group
  component [Call] as Call
  component [Status] as Status
  component [Contact] as Contact
  component [Notification] as Notification
  component [FileUpload] as FileUpload
}

package "Association Entities" {
  component [ChatParticipant] as ChatParticipant
  component [GroupParticipant] as GroupParticipant
  component [CallParticipant] as CallParticipant
  component [MessageRead] as MessageRead
  component [MessageReaction] as MessageReaction
  component [StatusView] as StatusView
  component [UserSettings] as UserSettings
  component [BlockedUser] as BlockedUser
}

package "Data Storage" {
  database [PostgreSQL\nPrimary DB] as PostgreSQL #LightBlue
  database [Redis\nCache & Session] as Redis #LightCoral
  component [File Storage\nMinIO/S3] as FileStorage #LightGreen
}

\' Core entity relationships
User --> Message : sends
User --> ChatParticipant : participates in
User --> GroupParticipant : participates in
User --> Group : creates
User --> Call : initiates
User --> CallParticipant : participates in
User --> Status : publishes
User --> StatusView : views
User --> Contact : owns
User --> Notification : receives
User --> FileUpload : uploads
User --> UserSettings : owns
User --> BlockedUser : blocks/blocked by

Chat --> Message : contains
Chat --> ChatParticipant : participants
Chat --> Call : related call

Message --> MessageRead : read receipts
Message --> MessageReaction : reactions
Message --> Message : replies to

Group --> GroupParticipant : members

Call --> CallParticipant : participants

Status --> StatusView : view records

\' Data storage relationships
User --> PostgreSQL : persisted in
Chat --> PostgreSQL : persisted in
Message --> PostgreSQL : persisted in
Group --> PostgreSQL : persisted in
Call --> PostgreSQL : persisted in
Status --> PostgreSQL : persisted in
Contact --> PostgreSQL : persisted in
Notification --> PostgreSQL : persisted in
FileUpload --> PostgreSQL : metadata in
ChatParticipant --> PostgreSQL : persisted in
GroupParticipant --> PostgreSQL : persisted in
CallParticipant --> PostgreSQL : persisted in
MessageRead --> PostgreSQL : persisted in
MessageReaction --> PostgreSQL : persisted in
StatusView --> PostgreSQL : persisted in
UserSettings --> PostgreSQL : persisted in
BlockedUser --> PostgreSQL : persisted in

User --> Redis : session cache
Chat --> Redis : presence cache
Message --> Redis : message queue

FileUpload --> FileStorage : file stored in

rectangle "Data Entity Notes" {
  note as N1
    **Core entities**
    - User: identity, profile, auth info, status
    - Chat: conversation session, direct/group chat
    - Message: message content, type, status
    - Group: group info and settings
    - Call: call records and state
    - Status: user status posts
    - Contact: contact entries
    - Notification: system/user notifications
    - FileUpload: file upload records
  end note
  
  note as N2
    **Association entities**
    - ChatParticipant: participants in a chat
    - GroupParticipant: members in a group
    - CallParticipant: participants in a call
    - MessageRead: message read status
    - MessageReaction: reactions to messages (likes, etc.)
    - StatusView: views of status posts
    - UserSettings: user preferences (theme, language, notifications, privacy, chat)
    - BlockedUser: block relationships between users
  end note
}

rectangle "Data Flow Notes" {
  note as N3
    **Write data flow**
    1. Client request -> application services
    2. Business logic -> data access layer
    3. Data validation & transformation
    4. Write to PostgreSQL (source of truth)
    5. Update Redis cache (hot data)
    6. Return result to client
  end note
  
  note as N4
    **Read data flow**
    1. Client request -> application services
    2. Check Redis cache
    3. Cache miss -> query PostgreSQL
    4. Write result back to Redis
    5. Return data to client
  end note
  
  note as N5
    **Realtime data flow**
    1. Data‑change event occurs
    2. Persist changes to PostgreSQL
    3. Publish event to Redis Pub/Sub
    4. WebSocket services subscribe & consume
    5. Push updates to online clients
  end note
}

note right of PostgreSQL
  **PostgreSQL primary database**
  - Persistent storage
  - ACID transactions
  - Relational data model
  - Full‑text search
  - Foreign‑key constraints
end note

note right of Redis
  **Redis cache & session store**
  - User session management
  - Online presence cache
  - Message queue (Pub/Sub)
  - Realtime data cache
  - Hot data cache
end note

note right of FileStorage
  **File storage service**
  - Image/video storage
  - File upload/download
  - CDN acceleration
  - Thumbnail generation
  - File versioning
end note

note bottom
  **Data architecture description**
  
  WhatsChat uses PostgreSQL as the primary relational store and Redis for caching and
  messaging:
  
  1. **Core entities** – User, Chat, Message, Group, Call, Status, Contact, Notification, FileUpload
  2. **Association entities** – ChatParticipant, GroupParticipant, CallParticipant, MessageRead,
     MessageReaction, StatusView, UserSettings, BlockedUser
  3. **Relationships** – one‑to‑one, one‑to‑many, and many‑to‑many modeled via foreign keys
     and junction tables
  4. **Storage** – PostgreSQL for persistent data, Redis for cache and sessions, object storage
     for media files
  5. **Data flows** – write, read, and realtime flows ensure both consistency and low‑latency reads
  
  The data model follows normalization principles to ensure integrity and consistency.
end note

@enduml
